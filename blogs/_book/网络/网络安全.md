### xss 跨站脚本攻击
#### 问题
在开发论坛过程中，大量遇到没有进行用户输入过滤的问题，导致出现xss安全问题
论坛搜索会通过url的形式携带参数去后台请求数据，当输入```<script>alert('111111')</script>```时后台会将搜索关键字返回到页面进行渲染。因此在跳转搜索结果页时，执行脚本期间会出现弹出框。

同样的，在帖子发布，回复的功能，如果对用户输入不进行处理，页面会执行用户输入的脚本文件，如果此时脚本文件是获取用户登录的cookie，并且将信息通过请求发送给攻击者，这会造成严重的安全隐患。

#### 概念
先说一下xss的概念。xss称为跨站脚本攻击， 攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全。


有三个分类：
1. 存储型
类似于帖子回帖评论功能，脚本会写入数据库中。用户返回页面时，网站由于这个隐患会将恶意代码从数据库中取出，拼接返回给浏览器。

2. 反射型
类似于例子中的搜索，```https://www.myquant.cn/community/search?term=ddd&in=titlesposts```这个连接并没有对参数进行过滤，所以很容易被攻击者伪造来攻击，如果query参数被攻击者伪造成一个获取cookie并发送出去的script脚本，例如```https://www.myquant.cn/community/search?term=<script>var cookies = document.cookie; ajax...</script>```   并且攻击者结合多种手段诱导用户点击，例如直接发送连接的形式。之后的后果也会有很大的安全性问题。

3. DOM型XSS
dom型和反射型类似，唯一的区别是反射型是服务端处理的参数，而DOM型是客户端js处理的参数。达到的目的也基本相同。这种形式的劫持有很多，像网络劫持是比较经典的一种。(v-html)


#### 如何防范：
首先不能在前端输入进行过滤，这样可以用工具绕开前端直接请求后端
再者是否能在后端写入数据库之前转义呢。
我们举一个例子，一个正常的用户输入了 5 < 7 这个内容，在写入数据库前，被转义，变成了 5 &lt; 7。
但这也存在问题，5 &lt; 7在输出位置展示的场景不同，当作为html拼接页面是可以正常显示的。

但是如果存储的值会作为ajax请求返回为变量，这些内容就不能直接用于类似Vue模板的渲染。
所以我们也要避免这种情形。
最终我通过“防止浏览器执行恶意代码”来防范XSS，具体形式是在数据到模板渲染的过程中，对数据进行过滤。

httponly

其他可以参考
https://juejin.im/post/5bad9140e51d450e935c6d64#heading-1



### csrf  跨站请求伪造
#### 场景：
登录A网站，没有退出的时候进入了B钓鱼网站，B网站调用A网站的接口请求，这时就达到了冒充用户的目的

如果有get接口漏洞，B网站可以在页面上加入图片，src会请求get接口

如果是post接口漏洞，B网站可以构造一个表单来做接口提交
#### 如何防御：
1. get请求不修改数据
2. 不让第三方访问cookie，sameSite: strict
3. 服务端对请求来源做验证，referer
4. 请求时附带验证信息  -   token
5. 双重cookie验证，把cookie带在url里，利用伪造者无法获取，只能借用



设置sameSite的弊端：

1. 兼容性问题
2. 多个子域名场景，如果用户信息都设置在主域名下，主域名网站内部跳转到其他子域名由于sameSite的设置，cookie不再携带，每个子域名下又要重新登录。



### 运营商拦截
运营商比较常见的作恶方式有三种，分别是 DNS劫持、http劫持、https劫持
DNS劫持：dns解析指向钓鱼网站，监管较严格，基本不存在
http劫持：http请求中插入一些广告，一般插入script标签和iframe标签
https挟持：通过木马的形式在客户端植入伪造的证书

#### 如何防止运营商拦截
核心：
    MutationObserver监控dom变化
    设置script，iframe标签src指向的白名单
    监控dom后过滤白名单，删除非白名单的脚本

缺点：
    只能删除动态的，header中注入的已经执行了，删除无效。